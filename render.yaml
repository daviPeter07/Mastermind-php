# render.yaml (Versão Corrigida)

databases:
- name: mastermind-db
  databaseName: mastermind_l0s0
  user: mastermind_user
  plan: free
  region: oregon

services:
- type: web
  name: mastermind-app
  runtime: docker
  repo: https://github.com/daviPeter07/Mastermind-php
  plan: free
  envVars:
  - key: DATABASE_URL
    fromDatabase:
      name: mastermind-db
      property: connectionString
  - key: MASTERMIND_API_TOKEN
    sync: false
  - key: TELEGRAM_BOT_TOKEN
    sync: false
  - key: JWT_SECRET
    sync: false
  region: oregon
  dockerContext: .
  dockerfilePath: ./Dockerfile

- type: worker
  name: mastermind-bot
  runtime: docker
  repo: https://github.com/daviPeter07/Mastermind-php
  plan: free
  # AQUI ESTÁ A MUDANÇA
  dockerCommand: |
    until php -r "try { new PDO(getenv('DATABASE_URL')); exit(0); } catch (PDOException \$e) { exit(1); }"; do
      echo "Aguardando o banco de dados..."
      sleep 1
    done
    php scripts/run-bot.php
  # FIM DA MUDANÇA
  envVars:
  - key: DATABASE_URL
    fromDatabase:
      name: mastermind-db
      property: connectionString
  - key: MASTERMIND_API_TOKEN
    sync: false
  - key: TELEGRAM_BOT_TOKEN
    sync: false
  - key: JWT_SECRET
    sync: false
  region: oregon
  dockerContext: .
  dockerfilePath: ./Dockerfile